<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghosts-EBook_Story</title>
    <!-- UPDATED: We need to import the Firebase library files -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        /* All the CSS styling remains the same - no changes here */
        @import url('https://fonts.googleapis.com/css2?family=Creepster&display=swap');
        :root{--primary-color:#8B0000;--secondary-color:#1a1a1a;--text-color:#f4f4f4;--background-color:#000000;--danger-color:#dc143c;}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;color:var(--text-color);background-color:var(--background-color);background-image:url('https://www.transparenttextures.com/patterns/cracks.png'),linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.9));background-attachment:fixed;overflow-x:hidden;}
        h1,h2,h3{font-family:'Creepster',cursive;color:var(--primary-color);letter-spacing:2px;text-shadow:2px 2px 4px rgba(0,0,0,0.7);}
        button,input[type="submit"]{background-color:var(--primary-color);color:var(--text-color);border:2px solid var(--danger-color);padding:10px 20px;cursor:pointer;font-size:1em;transition:all 0.3s ease;box-shadow:0 0 10px var(--primary-color);}
        button:hover,input[type="submit"]:hover{background-color:var(--danger-color);box-shadow:0 0 20px var(--danger-color);}
        input[type="text"],input[type="password"],textarea{background-color:var(--secondary-color);border:1px solid var(--primary-color);color:var(--text-color);padding:10px;width:calc(100% - 22px);}
        header{display:flex;justify-content:space-between;align-items:center;padding:15px 30px;background:linear-gradient(to bottom,#111,transparent);border-bottom:2px solid var(--primary-color);}
        .logo-container{display:flex;align-items:center;}
        .logo{width:70px;height:70px;background-color:var(--secondary-color);border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:40px;border:3px solid var(--primary-color);box-shadow:0 0 15px var(--danger-color),inset 0 0 10px rgba(0,0,0,0.5);margin-right:20px;animation:pulse 2s infinite;}
        @keyframes pulse{0%{box-shadow:0 0 15px var(--danger-color),inset 0 0 10px rgba(0,0,0,0.5);}50%{box-shadow:0 0 25px var(--danger-color),inset 0 0 10px rgba(0,0,0,0.5);}100%{box-shadow:0 0 15px var(--danger-color),inset 0 0 10px rgba(0,0,0,0.5);}}
        .website-name{font-size:2.5em;font-family:'Creepster',cursive;color:var(--text-color);text-shadow:3px 3px 0 var(--primary-color);}
        .profile-area{display:flex;align-items:center;gap:15px;}
        .profile-pic{width:50px;height:50px;border-radius:50%;background-color:var(--secondary-color);border:2px solid var(--primary-color);background-size:cover;background-position:center;cursor:pointer;}
        #username-display{font-weight:bold;}
        main{padding:20px;max-width:1200px;margin:20px auto;}
        #login-screen{max-width:400px;margin:100px auto;padding:40px;border:2px solid var(--primary-color);background-color:rgba(10,10,10,0.8);box-shadow:0 0 20px rgba(139,0,0,0.5);}
        #login-screen h2{text-align:center;font-size:3em;}
        #login-form div{margin-bottom:20px;}
        #admin-panel{background:rgba(139,0,0,0.1);border:1px dashed var(--primary-color);padding:20px;margin-bottom:40px;}
        #ebook-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:25px;}
        .ebook-card{background-color:var(--secondary-color);border:2px solid #333;text-align:center;padding:20px;cursor:pointer;transition:all 0.3s ease;position:relative;}
        .ebook-card:hover{transform:scale(1.05);border-color:var(--danger-color);box-shadow:0 0 15px var(--danger-color);}
        .ebook-title{font-family:'Creepster',cursive;font-size:1.8em;color:var(--primary-color);}
        .delete-book-btn{position:absolute;top:-10px;right:-10px;background-color:black;color:var(--danger-color);border:1px solid var(--danger-color);border-radius:50%;width:30px;height:30px;font-weight:bold;display:flex;justify-content:center;align-items:center;padding:0;line-height:0;}
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.8);}
        .modal-content{background-color:var(--secondary-color);margin:2% auto;padding:30px;border:2px solid var(--primary-color);width:80%;max-width:900px;box-shadow:0 0 30px var(--primary-color);position:relative;}
        .close-btn{color:#aaa;position:absolute;top:10px;right:25px;font-size:35px;font-weight:bold;cursor:pointer;}
        #ebook-content{height:75vh;overflow-y:auto;border:1px solid #333;padding:15px;margin-bottom:20px;background:#111;}
        #ebook-content pre{white-space:pre-wrap;word-wrap:break-word;font-size:1.1em;line-height:1.6;}
        #ebook-content iframe{width:100%;height:100%;border:none;background:#fff;}
        #comments-section{margin-top:30px;}
        .comment{background:#252525;padding:10px;border-left:3px solid var(--primary-color);margin-bottom:10px;}
        .comment-author{font-weight:bold;color:var(--danger-color);}
        .hidden{display:none!important;}
        .toast{position:fixed;top:20px;right:20px;background-color:var(--secondary-color);color:var(--text-color);padding:16px 24px;border-left:5px solid var(--danger-color);border-radius:4px;box-shadow:0 5px 15px rgba(139,0,0,0.5);z-index:2000;transform:translateX(120%);opacity:0;transition:transform .5s ease-in-out,opacity .5s ease-in-out;max-width:350px;pointer-events:none;}
        .toast.show{transform:translateX(0);opacity:1;}
        .toast-title{font-family:'Creepster',cursive;font-size:1.3em;color:var(--danger-color);margin:0 0 5px 0;letter-spacing:1px;}
        .toast-body{font-size:1em;}
    </style>
</head>
<body>
    <div id="notification-toast" class="toast"></div>
    <div id="login-screen">
        <h2>Welcome to Ghosts-EBook_Story</h2>
        <form id="login-form">
            <div>
                <label for="username">Username:</label>
                <input type="text" id="username" required>
            </div>
            <div>
                <label for="password">Password (for Admin only):</label>
                <input type="password" id="password">
            </div>
            <button type="submit">Enter the Shadows</button>
        </form>
    </div>
    <div id="main-app" class="hidden">
        <header>
            <div class="logo-container">
                <div class="logo">ðŸ‘»</div>
                <h1 class="website-name">Ghosts-EBook_Story</h1>
            </div>
            <div class="profile-area">
                <div id="username-display"></div>
                <div id="profile-pic" class="profile-pic" title="Edit Profile"></div>
            </div>
        </header>
        <main>
            <div id="admin-panel" class="hidden">
                <h2>Admin Controls</h2>
                <form id="upload-form">
                    <h3>Upload New E-Book</h3>
                    <p>Select a .txt or .html file to upload as a new story.</p>
                    <input type="text" id="ebook-upload-title" placeholder="E-Book Title" required><br><br>
                    <input type="file" id="ebook-file-input" accept=".txt,.html" required><br><br>
                    <button type="submit">Upload E-Book</button>
                </form>
            </div>
            <h2>E-Book Library</h2>
            <div id="ebook-grid"></div>
        </main>
    </div>
    <div id="ebook-reader-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-reader-btn">&times;</span>
            <h2 id="reader-title">Book Title</h2>
            <div id="ebook-content"></div>
            <div id="comments-section">
                <h3>Whispers from the Void (Comments)</h3>
                <div id="comments-list"></div>
                <form id="comment-form">
                    <textarea id="comment-text" rows="3" placeholder="Leave your mark..." required></textarea><br><br>
                    <button type="submit">Post Comment</button>
                </form>
            </div>
        </div>
    </div>
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-profile-btn">&times;</span>
            <h2>Edit Your Profile</h2>
            <form id="profile-form">
                <div>
                    <label for="new-username">Change Username:</label>
                    <input type="text" id="new-username">
                </div><br>
                <div>
                    <label for="profile-pic-upload">Upload Profile Picture:</label>
                    <input type="file" id="profile-pic-upload" accept="image/*">
                </div><br>
                <button type="submit">Save Changes</button>
            </form>
            <hr style="border-color: var(--primary-color); margin: 25px 0;">
            <div style="text-align: center;">
                 <button id="logout-btn">Log Out</button>
            </div>
        </div>
    </div>

    <script>
        // ===================================================================
        // FIREBASE SETUP - PASTE YOUR KEYS FROM STEP 1 HERE!
        // ===================================================================
        const firebaseConfig = {
            apiKey: "AIza...", // PASTE YOUR KEYS HERE
            authDomain: "your-project-id.firebaseapp.com", // PASTE YOUR KEYS HERE
            projectId: "your-project-id", // PASTE YOUR KEYS HERE
            storageBucket: "your-project-id.appspot.com", // PASTE YOUR KEYS HERE
            messagingSenderId: "1234567890", // PASTE YOUR KEYS HERE
            appId: "1:1234567890:web:abcdef123456" // PASTE YOUR KEYS HERE
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // Our connection to the database
        // ===================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // DOM elements are the same
            const loginScreen=document.getElementById("login-screen"),mainApp=document.getElementById("main-app"),loginForm=document.getElementById("login-form"),usernameInput=document.getElementById("username"),passwordInput=document.getElementById("password"),logoutBtn=document.getElementById("logout-btn"),usernameDisplay=document.getElementById("username-display"),profilePic=document.getElementById("profile-pic"),adminPanel=document.getElementById("admin-panel"),uploadForm=document.getElementById("upload-form"),ebookGrid=document.getElementById("ebook-grid"),ebookReaderModal=document.getElementById("ebook-reader-modal"),closeReaderBtn=document.getElementById("close-reader-btn"),readerTitle=document.getElementById("reader-title"),ebookContent=document.getElementById("ebook-content"),commentForm=document.getElementById("comment-form"),commentsList=document.getElementById("comments-list"),profileModal=document.getElementById("profile-modal"),closeProfileBtn=document.getElementById("close-profile-btn"),profileForm=document.getElementById("profile-form"),newUsernameInput=document.getElementById("new-username"),notificationToast=document.getElementById("notification-toast");

            let state = {
                currentUser: null,
                ebooks: [] // We will now fetch this from Firebase
            };

            // No more localStorage!

            const showView=(e)=>{loginScreen.classList.add("hidden"),mainApp.classList.add("hidden"),"login"===e?loginScreen.classList.remove("hidden"):"app"===e&&mainApp.classList.remove("hidden")};
            let notificationTimeout;const showNotification=(e,t)=>{clearTimeout(notificationTimeout),notificationToast.innerHTML=`\n                <div class="toast-title">${e}</div>\n                <div class="toast-body">${t}</div>\n            `,notificationToast.classList.add("show"),notificationTimeout=setTimeout(()=>{notificationToast.classList.remove("show")},5e3)};
            
            // UPDATED: renderEbooks now uses the state.ebooks array (filled from Firebase)
            const renderEbooks=()=>{ebookGrid.innerHTML="",0===state.ebooks.length?ebookGrid.innerHTML="<p>The library is empty... The Admin must scribe a new tale.</p>":state.ebooks.forEach(e=>{const t=document.createElement("div");t.className="ebook-card",t.dataset.id=e.id,t.innerHTML=`<h3 class="ebook-title">${e.title}</h3>`,state.currentUser&&state.currentUser.isAdmin&&(()=>{const o=document.createElement("button");o.className="delete-book-btn",o.innerHTML="&times;",o.dataset.id=e.id,o.title="Delete this E-Book",t.appendChild(o)})(),ebookGrid.appendChild(t)})};
            
            // This function now just uses the data already loaded into the state
            const renderComments=(e)=>{const t=state.ebooks.find(t=>t.id==e);commentsList.innerHTML="",t&&t.comments.length>0?t.comments.forEach(e=>{const t=document.createElement("div");t.className="comment";const o=JSON.parse(localStorage.getItem("profiles")||"{}")[e.username]||{pic:""},s=o.pic?`<img src="${o.pic}" style="width:20px; height:20px; border-radius:50%; vertical-align:middle; margin-right: 5px;">`:"";t.innerHTML=`<p class="comment-author">${s}${e.username} says:</p><p>${e.text}</p>`,commentsList.appendChild(t)}):commentsList.innerHTML="<p>Silence... No one has whispered here yet.</p>"};
            
            // Profile pictures are still stored in localStorage for simplicity, as they are user-specific
            const updateProfileUI=()=>{if(!state.currentUser)return;const e=state.currentUser.username;usernameDisplay.textContent=e;const t=JSON.parse(localStorage.getItem("profiles")||"{}")[e]||{pic:""};t.pic?(profilePic.style.backgroundImage=`url(${t.pic})`,profilePic.innerHTML=""):(profilePic.style.backgroundImage="none",profilePic.innerHTML=e.charAt(0).toUpperCase(),profilePic.style.textAlign="center",profilePic.style.fontSize="24px",profilePic.style.lineHeight="48px")};

            // --- MAIN APP LOGIC ---
            const init = async () => {
                const loggedInUser = sessionStorage.getItem('currentUser');
                if (loggedInUser) {
                    state.currentUser = JSON.parse(loggedInUser);
                    showView('app');
                    adminPanel.classList.toggle('hidden', !state.currentUser.isAdmin);
                    
                    // NEW: Fetch all books from Firebase when the app starts
                    try {
                        const snapshot = await db.collection("ebooks").get();
                        state.ebooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderEbooks();
                    } catch (error) {
                        console.error("Error fetching books: ", error);
                        ebookGrid.innerHTML = "<p>Could not connect to the library. The spirits are angry.</p>";
                    }
                    
                    updateProfileUI();
                } else {
                    showView('login');
                }
            };

            // --- EVENT LISTENERS (many are now async) ---
            loginForm.addEventListener("submit",e=>{e.preventDefault();const t=usernameInput.value.trim(),o=passwordInput.value;if(!t)return void alert("Username cannot be empty.");"Admin"===t&&"Admin"===o?state.currentUser={username:"Admin",isAdmin:!0}:(state.currentUser={username:t,isAdmin:!1},(()=>{const e=JSON.parse(localStorage.getItem("profiles")||"{}");e[t]||(e[t]={pic:""},localStorage.setItem("profiles",JSON.stringify(e)))})()),sessionStorage.setItem("currentUser",JSON.stringify(state.currentUser)),init(),loginForm.reset()});
            logoutBtn.addEventListener("click",()=>{sessionStorage.removeItem("currentUser"),state.currentUser=null,profileModal.style.display="none",init()});
            
            // UPDATED: Upload now saves to Firebase
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('ebook-upload-title').value;
                const fileInput = document.getElementById('ebook-file-input');
                const file = fileInput.files[0];

                if (title && file) {
                    const fileType = file.name.endsWith('.html') ? 'html' : 'text';
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const newBook = { title, content: event.target.result, type: fileType, comments: [], createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                        try {
                            const docRef = await db.collection("ebooks").add(newBook);
                            // Add the new book to our local state so we can see it instantly
                            state.ebooks.push({ id: docRef.id, ...newBook });
                            renderEbooks();
                            uploadForm.reset();
                            showNotification('A New Tale Appears!', `The e-book "${title}" has been summoned to the library.`);
                        } catch (error) {
                            console.error("Error adding document: ", error);
                            showNotification('Upload Failed!', 'The spirits rejected the offering.');
                        }
                    };
                    reader.readAsText(file);
                }
            });

            // UPDATED: Deleting a book now removes it from Firebase
            ebookGrid.addEventListener('click', async (e) => {
                const card=e.target.closest(".ebook-card"),deleteBtn=e.target.closest(".delete-book-btn");
                if (deleteBtn) {
                    e.stopPropagation();
                    if (confirm('Are you sure you want to banish this book to the void?')) {
                        const bookId = deleteBtn.dataset.id;
                        try {
                            await db.collection("ebooks").doc(bookId).delete();
                            // Remove from local state and re-render
                            state.ebooks = state.ebooks.filter(b => b.id !== bookId);
                            renderEbooks();
                        } catch (error) {
                            console.error("Error deleting book: ", error);
                            alert("Failed to delete the book.");
                        }
                    }
                    return;
                }
                if (card) {
                    const bookId = card.dataset.id;
                    const book = state.ebooks.find(b => b.id == bookId);
                    if (book) {
                        readerTitle.textContent = book.title;
                        ebookContent.innerHTML = '';
                        if (book.type === 'html') {
                            const iframe = document.createElement('iframe');
                            iframe.srcdoc = book.content; iframe.sandbox = 'allow-scripts allow-same-origin';
                            ebookContent.appendChild(iframe);
                        } else {
                            const pre = document.createElement('pre');
                            pre.textContent = book.content; ebookContent.appendChild(pre);
                        }
                        commentForm.dataset.bookId = bookId;
                        renderComments(bookId); ebookReaderModal.style.display = 'block';
                    }
                }
            });

            closeReaderBtn.onclick=()=>ebookReaderModal.style.display="none";closeProfileBtn.onclick=()=>profileModal.style.display="none";window.onclick=e=>{e.target==ebookReaderModal&&(ebookReaderModal.style.display="none"),e.target==profileModal&&(profileModal.style.display="none")};
            
            // UPDATED: Comments are now saved to Firebase
            commentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = document.getElementById('comment-text').value.trim();
                const bookId = e.target.dataset.bookId;
                if (text) {
                    const book = state.ebooks.find(b => b.id == bookId);
                    if (book) {
                        const newComment = { username: state.currentUser.username, text: text };
                        // Add the new comment to the existing array of comments
                        const updatedComments = [...book.comments, newComment];
                        try {
                            await db.collection("ebooks").doc(bookId).update({ comments: updatedComments });
                            // Update local state
                            book.comments = updatedComments;
                            renderComments(bookId);
                            commentForm.reset();
                        } catch (error) {
                            console.error("Error adding comment: ", error);
                            alert("Could not post comment.");
                        }
                    }
                }
            });
            
            // Profile management still uses localStorage as it's user-specific
            profilePic.addEventListener("click",()=>{newUsernameInput.value=state.currentUser.username,profileModal.style.display="block"});
            profileForm.addEventListener("submit",e=>{e.preventDefault();const t=newUsernameInput.value.trim(),o=document.getElementById("profile-pic-upload").files[0],s=state.currentUser.username;if(t&&t!==s){const e=JSON.parse(localStorage.getItem("profiles")||"{}");e[t]=e[s]||{pic:""},"Admin"!==s&&delete e[s],localStorage.setItem("profiles",JSON.stringify(e)),state.currentUser.username=t,sessionStorage.setItem("currentUser",JSON.stringify(state.currentUser))}const n=e=>{const t=JSON.parse(localStorage.getItem("profiles")||"{}");t[state.currentUser.username].pic=e,localStorage.setItem("profiles",JSON.stringify(t)),updateProfileUI(),profileModal.style.display="none"};o?(()=>{const e=new FileReader;e.onload=t=>n(t.target.result),e.readAsDataURL(o)})():(updateProfileUI(),profileModal.style.display="none")});

            init();
        });
    </script>
</body>
</html>
